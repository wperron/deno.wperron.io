<!DOCTYPE html>
<head>
    <meta charset="utf8" />
    <title>wperron.io | Deno Modules</title>
    <script src="/aws-sdk-2.774.0.min.js"></script>
</head>
<body>
    <h1>Personal Deno Regsitry</h1>

    <section id="content"></section>

    <script type="module">
        AWS.config.region = 'ca-central-1';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'ca-central-1:5ec37d17-d516-470f-91a2-6b308a4c772f',
        });

        AWS.config.credentials.refresh();
        const s3 = new AWS.S3();

        function leftTrim(str, char = "\s") {
            if (char === "") return str;
            let offset = 0;
            while (str.indexOf(char, offset) === 0 && offset < str.length) {
                offset += char.length;
            }
            return str.slice(offset);
        }

        const location = leftTrim(window.location.pathname, "/");

        // get directory tree from localstorage at given key
        async function populate(key) {
            const res = await s3.listObjects({
                Bucket: "deno.wperron.io",
                Prefix: location
                    ? location.endsWith("/") ? location : location + "/"
                    : "",
            }).promise();

            const links = new Set();
            res.Contents.forEach((obj) => {
                const key = leftTrim(obj.Key, location.endsWith("/") ? location : location + "/");
                const parts = key.split("/");

                // filter out objects living at the bucket root like index.html
                // or the aws sdk.
                if (location === "" && parts.length > 1) {
                    links.add(parts[0]);
                }
            });

            const root = document.querySelector("#content");
            const list = root.appendChild(document.createElement("ul"));
            for (const link of links) {
                const atag = document.createElement("a");
                atag.innerText = link;
                atag.setAttribute("href", `${location}/${link}`);
                const listitem = document.createElement("li");
                listitem.appendChild(atag);
                list.appendChild(listitem);
            }
        }

        populate();
    </script>
</body>
